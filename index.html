<div>Teachable Machine Image Model</div>
<button type="button" onclick="startPrediction()">Start</button>
<div id="webcam-container"></div>
<div id="countdown" style="font-size:24px; margin-top:10px; color:green;"></div>
<div id="label-container"></div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

<script>
    const URL = "https://teachablemachine.withgoogle.com/models/rdcqB69I8/";

    let model, webcam, labelContainer, maxPredictions;
    let lastClass = "";
    let countdownValue = 5;
    let countdownInterval;
    let modelReady = false;

    async function initModel() {
        if (!modelReady) {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";
            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();

            const flip = true;
            webcam = new tmImage.Webcam(200, 200, flip);
            await webcam.setup();
            await webcam.play();
            window.requestAnimationFrame(loop);

            document.getElementById("webcam-container").appendChild(webcam.canvas);
            labelContainer = document.getElementById("label-container");
            for (let i = 0; i < maxPredictions; i++) {
                labelContainer.appendChild(document.createElement("div"));
            }
            modelReady = true;
        }
    }

    function loop() {
        webcam.update();
        window.requestAnimationFrame(loop);
    }

    async function startPrediction() {
        await initModel(); // tải model nếu chưa tải
        countdownValue = 5;
        document.getElementById("countdown").innerText = `Dự đoán sau: ${countdownValue} giây`;

        if (countdownInterval) clearInterval(countdownInterval);

        countdownInterval = setInterval(async () => {
            countdownValue--;
            document.getElementById("countdown").innerText = `Dự đoán sau: ${countdownValue} giây`;

            if (countdownValue <= 0) {
                clearInterval(countdownInterval);
                await predict(); // dự đoán 1 lần
                document.getElementById("countdown").innerText = "Hoàn thành!";
            }
        }, 1000);
    }

    async function predict() {
        const prediction = await model.predict(webcam.canvas);
        let highestClass = "";
        let highestProb = 0;

        for (let i = 0; i < maxPredictions; i++) {
            const classPrediction =
                prediction[i].className + ": " + prediction[i].probability.toFixed(2);
            labelContainer.childNodes[i].innerHTML = classPrediction;

            if (prediction[i].probability > highestProb) {
                highestProb = prediction[i].probability;
                highestClass = prediction[i].className;
            }
        }

        if (highestProb > 0.8 && highestClass !== lastClass) {
            lastClass = highestClass;
            if (highestClass === "1") {
                document.body.style.backgroundColor = "red";
                playSound("happy.mp3");
            } else if (highestClass === "2") {
                document.body.style.backgroundColor = "blue";
                playSound("sad.mp3");
            } else if (highestClass === "3") {
                document.body.style.backgroundColor = "yellow";
                playSound("surprise.mp3");
            }
            setTimeout(() => lastClass = "", 2000);
        }
    }

    function playSound(file) {
        const audio = new Audio(file);
        audio.play();
    }
</script>
