<div>Teachable Machine Image Model</div>
<button type="button" id="startBtn" onclick="startPrediction()">Start</button>
<div id="webcam-container"></div>
<div id="countdown" style="font-size:24px; margin-top:10px; color:green;"></div>
<div id="label-container"></div>
<hr>
<div id="history" style="margin-top:20px;">
    <h3>Lịch sử dự đoán</h3>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

<script>
    const URL = "https://teachablemachine.withgoogle.com/models/rdcqB69I8/";

    let model, webcam, labelContainer, maxPredictions;
    let modelReady = false;
    let attemptCount = 0; 
    let audioPlayer = null;
    let countdownInterval = null;

    async function initModel() {
        if (!modelReady) {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";
            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();

            const flip = true;
            webcam = new tmImage.Webcam(200, 200, flip);
            await webcam.setup();
            await webcam.play();
            window.requestAnimationFrame(loop);

            document.getElementById("webcam-container").appendChild(webcam.canvas);
            labelContainer = document.getElementById("label-container");
            for (let i = 0; i < maxPredictions; i++) {
                labelContainer.appendChild(document.createElement("div"));
            }
            modelReady = true;
        }
    }

    function loop() {
        webcam.update();
        window.requestAnimationFrame(loop);
    }

    async function startPrediction() {
        await initModel();

        // Dừng nhạc cũ
        if (audioPlayer) {
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
        }

        // Dừng đếm ngược cũ nếu còn
        if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
        }

        // Tăng số lần
        attemptCount++;

        // Bắt đầu đếm ngược 5 giây
        let countdownValue = 5;
        document.getElementById("countdown").innerText = `Dự đoán sau: ${countdownValue} giây`;

        countdownInterval = setInterval(async () => {
            countdownValue--;
            document.getElementById("countdown").innerText = `Dự đoán sau: ${countdownValue} giây`;

            if (countdownValue <= 0) {
                clearInterval(countdownInterval);
                countdownInterval = null; // reset trạng thái
                await predict(attemptCount);
                document.getElementById("countdown").innerText = "Hoàn thành!";
            }
        }, 1000);
    }

    async function predict(attemptNumber) {
        webcam.update(); // đảm bảo ảnh mới

        const prediction = await model.predict(webcam.canvas);
        let highestClass = "";
        let highestProb = 0;

        for (let i = 0; i < maxPredictions; i++) {
            const classPrediction =
                prediction[i].className + ": " + prediction[i].probability.toFixed(2);
            labelContainer.childNodes[i].innerHTML = classPrediction;

            if (prediction[i].probability > highestProb) {
                highestProb = prediction[i].probability;
                highestClass = prediction[i].className;
            }
        }

        if (highestProb > 0.8) {
            // Lưu lịch sử
            const historyEl = document.getElementById("history");
            const resultItem = document.createElement("div");
            const timeNow = new Date().toLocaleTimeString();
            resultItem.innerText = `Lần ${attemptNumber} (${timeNow}): ${highestClass} (${highestProb.toFixed(2)})`;
            historyEl.appendChild(resultItem);

            // Đổi màu nền + phát nhạc
            if (highestClass === "1") {
                document.body.style.backgroundColor = "red";
                playSound("happy.mp3");
            } else if (highestClass === "2") {
                document.body.style.backgroundColor = "blue";
                playSound("sad.mp3");
            } else if (highestClass === "3") {
                document.body.style.backgroundColor = "yellow";
                playSound("surprise.mp3");
            }
        }
    }

    function playSound(file) {
        audioPlayer = new Audio(file);
        audioPlayer.play();
    }
</script>
